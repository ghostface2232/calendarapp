<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#f2f2f7" />
  <meta name="color-scheme" content="light" />
  <title>DayRail</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./icons/icon-192.png" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />

  <style>
    :root{
      --bg: #f2f2f7;
      --surface: #ffffff;
      --ink: #111115;
      --muted: #6b6b74;
      --hair: rgba(20,20,26,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius-lg: 22px;
      --radius-md: 16px;
      --radius-sm: 12px;

      --blue: #007aff;
      --blue-weak: rgba(0,122,255,.12);

      --chip-gray: #e9e9ee;
      --chip-gray-ink: #26262c;

      --chip-yellow: #ffe39b;
      --chip-yellow-ink: #7a5a00;

      --chip-green: #b9f7b4;
      --chip-green-ink: #155d1c;

      --chip-purple: #e2d3ff;
      --chip-purple-ink: #4a2a8a;

      --chip-red: #ffd1d1;
      --chip-red-ink: #7a1d1d;

      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
    }

    *{ box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", Segoe UI, Roboto, Helvetica, Arial, "Segoe UI Emoji";
      background: var(--bg);
      color: var(--ink);
    }

    button, input, select, textarea{
      font: inherit;
      color: inherit;
    }

    .app{
      min-height: 100%;
      padding: calc(10px + var(--safe-top)) calc(14px + var(--safe-right)) calc(96px + var(--safe-bottom)) calc(14px + var(--safe-left));
      display: flex;
      justify-content: center;
    }

    .shell{
      width: min(920px, 100%);
    }

    .topHint{
      font-size: 12px;
      color: rgba(20,20,26,.28);
      margin: 0 0 8px 10px;
      user-select: none;
    }

    .topBar{
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 10px;
      padding: 6px 6px 10px;
    }

    .monthBtn{
      justify-self: start;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: rgba(255,255,255,.65);
      border: 1px solid var(--hair);
      border-radius: 999px;
      box-shadow: 0 1px 0 rgba(0,0,0,.04);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      cursor: pointer;
      user-select: none;
    }
    .monthBtn:active{ transform: translateY(1px); }
    .chev{
      width: 10px; height: 10px;
      border-left: 2px solid rgba(20,20,26,.55);
      border-bottom: 2px solid rgba(20,20,26,.55);
      transform: rotate(45deg);
      margin-left: 2px;
    }

    .title{
      justify-self: center;
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -.2px;
      user-select: none;
    }

    .ghostRight{
      justify-self: end;
      display: flex;
      gap: 8px;
      align-items: center;
      user-select: none;
    }

    .miniBtn{
      height: 36px;
      padding: 0 12px;
      border: 1px solid var(--hair);
      background: rgba(255,255,255,.65);
      border-radius: 999px;
      cursor: pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,.04);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .miniBtn:active{ transform: translateY(1px); }

    .dateRailWrap{
      background: rgba(255,255,255,.55);
      border: 1px solid var(--hair);
      border-radius: var(--radius-lg);
      box-shadow: 0 1px 0 rgba(0,0,0,.04);
      padding: 14px 14px 12px;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    .dowRow{
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      padding: 0 2px 10px;
      color: rgba(20,20,26,.30);
      font-weight: 700;
      font-size: 12px;
      letter-spacing: .2px;
      user-select: none;
    }
    .dowRow span{ text-align: center; }

    .dateRail{
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding: 2px 2px 6px;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .dateRail::-webkit-scrollbar{ height: 6px; }
    .dateRail::-webkit-scrollbar-thumb{ background: rgba(20,20,26,.12); border-radius: 999px; }
    .dateRail::-webkit-scrollbar-track{ background: transparent; }

    .dayBtn{
      min-width: 56px;
      height: 56px;
      border-radius: 18px;
      border: 1px solid transparent;
      background: rgba(255,255,255,.0);
      display: grid;
      place-items: center;
      scroll-snap-align: start;
      cursor: pointer;
      user-select: none;
    }
    .dayNum{
      width: 38px;
      height: 38px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      font-size: 20px;
      font-weight: 800;
      letter-spacing: -.2px;
      color: rgba(20,20,26,.86);
      background: transparent;
      transition: background .12s ease, color .12s ease, transform .12s ease;
    }
    .dayBtn:hover .dayNum{
      background: rgba(20,20,26,.05);
    }
    .dayBtn[aria-selected="true"] .dayNum{
      background: var(--blue-weak);
      color: var(--blue);
    }
    .dayBtn:active .dayNum{ transform: scale(.98); }

    .content{
      margin-top: 14px;
      display: grid;
      gap: 14px;
    }

    .emptyState{
      padding: 22px 20px;
      border-radius: var(--radius-lg);
      border: 1px dashed rgba(20,20,26,.18);
      color: rgba(20,20,26,.55);
      background: rgba(255,255,255,.40);
    }

    .card{
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      padding: 18px 18px 16px;
      border: 1px solid rgba(20,20,26,.06);
    }

    .rowTop{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .cardTitle{
      font-size: 28px;
      font-weight: 800;
      letter-spacing: -.4px;
      line-height: 1.05;
      margin: 0;
      flex: 1;
      min-width: 0;
    }

    .timePill{
      flex: 0 0 auto;
      padding: 8px 12px;
      background: var(--chip-gray);
      color: rgba(20,20,26,.85);
      border-radius: 999px;
      font-weight: 800;
      letter-spacing: .2px;
      font-variant-numeric: tabular-nums;
      user-select: none;
    }

    .divider{
      height: 1px;
      background: rgba(20,20,26,.08);
      margin: 12px 0 12px;
    }

    .rowMeta{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .source{
      color: rgba(20,20,26,.60);
      font-weight: 700;
      letter-spacing: -.1px;
      user-select: none;
    }

    .tagPill{
      padding: 8px 14px;
      border-radius: 999px;
      font-weight: 900;
      letter-spacing: -.1px;
      user-select: none;
      white-space: nowrap;
    }

    .tag-yellow{ background: var(--chip-yellow); color: var(--chip-yellow-ink); }
    .tag-green{ background: var(--chip-green); color: var(--chip-green-ink); }
    .tag-blue{ background: rgba(0,122,255,.16); color: #0059bf; }
    .tag-purple{ background: var(--chip-purple); color: var(--chip-purple-ink); }
    .tag-red{ background: var(--chip-red); color: var(--chip-red-ink); }
    .tag-gray{ background: var(--chip-gray); color: var(--chip-gray-ink); }

    .note{
      margin-top: 10px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(20,20,26,.08);
      padding: 12px 12px;
      background: rgba(242,242,247,.55);
    }

    .note textarea{
      width: 100%;
      min-height: 44px;
      resize: vertical;
      border: 0;
      outline: 0;
      background: transparent;
      color: rgba(20,20,26,.85);
      font-weight: 650;
      letter-spacing: -.1px;
      line-height: 1.35;
    }
    .note textarea::placeholder{ color: rgba(20,20,26,.25); }

    .cardActions{
      margin-top: 12px;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .linkBtn{
      border: 1px solid rgba(20,20,26,.10);
      background: rgba(255,255,255,.55);
      padding: 8px 12px;
      border-radius: 999px;
      cursor: pointer;
      color: rgba(20,20,26,.75);
      font-weight: 750;
    }
    .linkBtn:active{ transform: translateY(1px); }
    .danger{ color: #7a1d1d; border-color: rgba(122,29,29,.18); background: rgba(255,209,209,.45); }

    .fab{
      position: fixed;
      left: 50%;
      bottom: calc(18px + var(--safe-bottom));
      transform: translateX(-50%);
      width: 64px;
      height: 64px;
      border-radius: 999px;
      border: 1px solid rgba(20,20,26,.10);
      background: rgba(255,255,255,.85);
      box-shadow: 0 18px 40px rgba(0,0,0,.16);
      display: grid;
      place-items: center;
      cursor: pointer;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
    .fab:active{ transform: translateX(-50%) translateY(1px); }
    .plus{
      width: 22px; height: 22px;
      position: relative;
    }
    .plus::before,.plus::after{
      content: "";
      position: absolute;
      left: 50%; top: 50%;
      transform: translate(-50%,-50%);
      background: var(--blue);
      border-radius: 3px;
    }
    .plus::before{ width: 22px; height: 4px; }
    .plus::after{ width: 4px; height: 22px; }

    .modalOverlay{
      position: fixed;
      inset: 0;
      background: rgba(10,10,14,.42);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }
    .modalOverlay[aria-hidden="false"]{ display: flex; }

    .modal{
      width: min(560px, 100%);
      background: rgba(255,255,255,.92);
      border-radius: 26px;
      border: 1px solid rgba(20,20,26,.10);
      box-shadow: 0 30px 90px rgba(0,0,0,.25);
      padding: 16px 16px 14px;
    }

    .modalHeader{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 6px 6px 10px;
    }
    .modalHeader h2{
      margin: 0;
      font-size: 18px;
      font-weight: 900;
      letter-spacing: -.2px;
    }

    .modalBody{
      padding: 6px 6px 2px;
      display: grid;
      gap: 12px;
    }

    .field{
      display: grid;
      gap: 6px;
    }
    .label{
      font-size: 12px;
      color: rgba(20,20,26,.52);
      font-weight: 800;
      letter-spacing: .2px;
      user-select: none;
    }
    .input, .select, .textarea{
      width: 100%;
      border: 1px solid rgba(20,20,26,.10);
      background: rgba(242,242,247,.70);
      border-radius: 14px;
      padding: 12px 12px;
      outline: none;
      font-weight: 750;
      letter-spacing: -.1px;
    }
    .textarea{
      min-height: 82px;
      resize: vertical;
      font-weight: 650;
      line-height: 1.35;
    }

    .modalFooter{
      display: flex;
      gap: 10px;
      justify-content: space-between;
      padding: 12px 6px 6px;
      align-items: center;
    }

    .primary{
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(0,122,255,.20);
      background: rgba(0,122,255,.12);
      color: #0059bf;
      font-weight: 900;
      cursor: pointer;
    }
    .secondary{
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(20,20,26,.12);
      background: rgba(255,255,255,.65);
      color: rgba(20,20,26,.80);
      font-weight: 900;
      cursor: pointer;
    }
    .primary:active, .secondary:active{ transform: translateY(1px); }

    .split{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    @media (min-width: 900px){
      .app{ padding-bottom: calc(44px + var(--safe-bottom)); }
      .fab{ left: calc(50% + 380px); transform: translateX(-50%); }
      .fab:active{ transform: translateX(-50%) translateY(1px); }
    }

    @media (prefers-reduced-motion: reduce){
      *{ transition: none !important; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="shell" role="application" aria-label="DayRail">
      <div class="topHint">Picker</div>

      <div class="topBar">
        <button class="monthBtn" id="monthBtn" type="button" aria-label="월 선택">
          <span class="chev" aria-hidden="true"></span>
          <span id="monthBtnLabel">12월</span>
        </button>

        <div class="title" id="titleLabel">12월 25일, 오늘</div>

        <div class="ghostRight">
          <button class="miniBtn" id="todayBtn" type="button">오늘</button>
        </div>
      </div>

      <div class="dateRailWrap" aria-label="날짜 탐색">
        <div class="dowRow" aria-hidden="true">
          <span>SUN</span><span>MON</span><span>TUE</span><span>WED</span><span>THU</span><span>FRI</span><span>SAT</span>
        </div>
        <div class="dateRail" id="dateRail"></div>
      </div>

      <main class="content" id="content"></main>
    </div>
  </div>

  <button class="fab" id="addBtn" type="button" aria-label="일정 추가">
    <div class="plus" aria-hidden="true"></div>
  </button>

  <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="일정 편집">
      <div class="modalHeader">
        <h2 id="modalTitle">새 일정</h2>
        <button class="secondary" id="closeModalBtn" type="button">닫기</button>
      </div>

      <div class="modalBody">
        <div class="field">
          <div class="label">제목</div>
          <input class="input" id="fTitle" type="text" placeholder="Title" autocomplete="off" />
        </div>

        <div class="split">
          <div class="field">
            <div class="label">시간</div>
            <input class="input" id="fTime" type="time" />
          </div>

          <div class="field">
            <div class="label">태그</div>
            <select class="select" id="fTag">
              <option value="todo">To-Do</option>
              <option value="workshop">Workshop</option>
              <option value="meeting">Meeting</option>
              <option value="personal">Personal</option>
              <option value="idea">Idea</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>
        </div>

        <div class="split">
          <div class="field">
            <div class="label">소스</div>
            <input class="input" id="fSource" type="text" placeholder="Calendar" autocomplete="off" />
          </div>

          <div class="field">
            <div class="label">날짜</div>
            <input class="input" id="fDate" type="date" />
          </div>
        </div>

        <div class="field">
          <div class="label">메모</div>
          <textarea class="textarea" id="fNote" placeholder="Write Something..."></textarea>
        </div>
      </div>

      <div class="modalFooter">
        <button class="secondary danger" id="deleteBtn" type="button" style="visibility:hidden;">삭제</button>
        <div style="display:flex; gap:10px;">
          <button class="secondary" id="cancelBtn" type="button">취소</button>
          <button class="primary" id="saveBtn" type="button">저장</button>
        </div>
      </div>
    </div>
  </div>

  <input id="monthPicker" type="month" style="position:fixed; left:-9999px; top:-9999px;" />

  <script>
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    const STORAGE_KEY = "dayrail.v1";

    const TAGS = {
      todo:   { label: "To-Do",    className: "tag-yellow" },
      workshop:{ label:"Workshop", className: "tag-green" },
      meeting:{ label:"Meeting",   className: "tag-blue" },
      personal:{label:"Personal",  className: "tag-purple" },
      idea:   { label: "Idea",     className: "tag-gray" },
      urgent: { label: "Urgent",   className: "tag-red" }
    };

    function pad2(n){ return String(n).padStart(2,"0"); }
    function isoDate(d){
      const x = new Date(d);
      x.setHours(0,0,0,0);
      return `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`;
    }
    function parseIsoDate(s){
      const [y,m,d] = s.split("-").map(Number);
      const dt = new Date(y, m-1, d);
      dt.setHours(0,0,0,0);
      return dt;
    }
    function startOfWeek(d){
      const x = new Date(d);
      const day = x.getDay(); // 0 Sun
      x.setDate(x.getDate() - day);
      x.setHours(0,0,0,0);
      return x;
    }
    function addDays(d, n){
      const x = new Date(d);
      x.setDate(x.getDate()+n);
      return x;
    }
    function isSameDay(a,b){
      return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
    }
    function formatTitle(d){
      const today = new Date(); today.setHours(0,0,0,0);
      const isToday = isSameDay(d, today);
      const fmt = new Intl.DateTimeFormat("ko-KR", { month:"long", day:"numeric" });
      return isToday ? `${fmt.format(d)}, 오늘` : fmt.format(d);
    }
    function formatMonth(d){
      return new Intl.DateTimeFormat("ko-KR", { month:"long" }).format(d);
    }
    function timeLabel(t){
      if(!t) return "All-day";
      const [hh, mm] = t.split(":").map(Number);
      const isAM = hh < 12;
      let h12 = hh % 12; if(h12===0) h12 = 12;
      const ap = isAM ? "AM" : "PM";
      return `${h12}:${pad2(mm)} ${ap}`;
    }
    function uuid(){
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function loadStore(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return { version: 1, items: {} };
        const data = JSON.parse(raw);
        if(!data || typeof data !== "object") throw new Error("bad");
        if(!data.items) data.items = {};
        return data;
      }catch(e){
        return { version: 1, items: {} };
      }
    }
    function saveStore(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
    }

    let store = loadStore();

    const state = {
      selected: new Date(),
      railAnchor: startOfWeek(new Date()),
      railDays: 28, // 4주치
      editingId: null,
      editingDate: null
    };

    const dateRail = $("#dateRail");
    const content = $("#content");
    const titleLabel = $("#titleLabel");
    const monthBtnLabel = $("#monthBtnLabel");

    const modalOverlay = $("#modalOverlay");
    const monthPicker = $("#monthPicker");

    const fTitle = $("#fTitle");
    const fTime  = $("#fTime");
    const fTag   = $("#fTag");
    const fSource= $("#fSource");
    const fDate  = $("#fDate");
    const fNote  = $("#fNote");

    const modalTitle = $("#modalTitle");
    const deleteBtn  = $("#deleteBtn");

    function ensureDayBucket(iso){
      if(!store.items[iso]) store.items[iso] = [];
      return store.items[iso];
    }

    function listForDay(iso){
      const arr = (store.items[iso] || []).slice();
      arr.sort((a,b)=>{
        const ta = a.time || "99:99";
        const tb = b.time || "99:99";
        if(ta < tb) return -1;
        if(ta > tb) return 1;
        return (a.updatedAt||0) - (b.updatedAt||0);
      });
      return arr;
    }

    function setSelected(d, {scrollIntoView=true}={}){
      const x = new Date(d); x.setHours(0,0,0,0);
      state.selected = x;

      titleLabel.textContent = formatTitle(x);
      monthBtnLabel.textContent = formatMonth(x).replace("월","월");
      renderList();

      const selIso = isoDate(x);
      const btn = dateRail.querySelector(`[data-iso="${selIso}"]`);
      if(btn){
        $$(`.dayBtn`, dateRail).forEach(b => b.setAttribute("aria-selected","false"));
        btn.setAttribute("aria-selected","true");
        if(scrollIntoView) btn.scrollIntoView({behavior:"smooth", inline:"center", block:"nearest"});
      }
    }

    function renderRail(){
      dateRail.innerHTML = "";
      const today = new Date(); today.setHours(0,0,0,0);

      for(let i=0;i<state.railDays;i++){
        const d = addDays(state.railAnchor, i);
        const iso = isoDate(d);

        const btn = document.createElement("button");
        btn.className = "dayBtn";
        btn.type = "button";
        btn.dataset.iso = iso;
        btn.setAttribute("aria-selected", isSameDay(d, state.selected) ? "true" : "false");
        btn.setAttribute("aria-label", new Intl.DateTimeFormat("ko-KR", { month:"long", day:"numeric", weekday:"short" }).format(d));

        const num = document.createElement("div");
        num.className = "dayNum";
        num.textContent = d.getDate();

        btn.appendChild(num);
        btn.addEventListener("click", () => setSelected(d));
        dateRail.appendChild(btn);
      }

      // 최초 로드 시 오늘 근처로 스크롤
      const todayIso = isoDate(today);
      const btnToday = dateRail.querySelector(`[data-iso="${todayIso}"]`);
      if(btnToday) btnToday.scrollIntoView({behavior:"instant", inline:"center"});
    }

    function renderList(){
      const iso = isoDate(state.selected);
      const items = listForDay(iso);

      content.innerHTML = "";
      if(items.length === 0){
        const empty = document.createElement("div");
        empty.className = "emptyState";
        empty.textContent = "이 날짜에는 등록된 일정이 없음";
        content.appendChild(empty);
        return;
      }

      for(const item of items){
        const card = document.createElement("section");
        card.className = "card";
        card.dataset.id = item.id;

        const rowTop = document.createElement("div");
        rowTop.className = "rowTop";

        const h = document.createElement("h3");
        h.className = "cardTitle";
        h.textContent = item.title || "Untitled";

        const time = document.createElement("div");
        time.className = "timePill";
        time.textContent = timeLabel(item.time);

        rowTop.appendChild(h);
        rowTop.appendChild(time);

        const div = document.createElement("div");
        div.className = "divider";

        const rowMeta = document.createElement("div");
        rowMeta.className = "rowMeta";

        const src = document.createElement("div");
        src.className = "source";
        src.textContent = item.source || "Calendar";

        const tag = document.createElement("div");
        const tagInfo = TAGS[item.tag] || TAGS.todo;
        tag.className = `tagPill ${tagInfo.className}`;
        tag.textContent = tagInfo.label;

        rowMeta.appendChild(src);
        rowMeta.appendChild(tag);

        const noteWrap = document.createElement("div");
        noteWrap.className = "note";

        const ta = document.createElement("textarea");
        ta.placeholder = "Write Something...";
        ta.value = item.note || "";
        ta.addEventListener("input", () => {
          const isoHere = isoDate(state.selected);
          const bucket = ensureDayBucket(isoHere);
          const idx = bucket.findIndex(x => x.id === item.id);
          if(idx >= 0){
            bucket[idx].note = ta.value;
            bucket[idx].updatedAt = Date.now();
            saveStore();
          }
        });

        noteWrap.appendChild(ta);

        const actions = document.createElement("div");
        actions.className = "cardActions";

        const editBtn = document.createElement("button");
        editBtn.className = "linkBtn";
        editBtn.type = "button";
        editBtn.textContent = "편집";
        editBtn.addEventListener("click", () => openEdit(item.id, iso));

        const delBtn = document.createElement("button");
        delBtn.className = "linkBtn danger";
        delBtn.type = "button";
        delBtn.textContent = "삭제";
        delBtn.addEventListener("click", () => {
          removeItem(iso, item.id);
          renderList();
        });

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        card.appendChild(rowTop);
        card.appendChild(div);
        card.appendChild(rowMeta);
        card.appendChild(noteWrap);
        card.appendChild(actions);

        content.appendChild(card);
      }
    }

    function openModal(){
      modalOverlay.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
      setTimeout(() => fTitle.focus(), 0);
    }
    function closeModal(){
      modalOverlay.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
      state.editingId = null;
      state.editingDate = null;
    }

    function openNew(){
      state.editingId = null;
      state.editingDate = isoDate(state.selected);

      modalTitle.textContent = "새 일정";
      deleteBtn.style.visibility = "hidden";

      fTitle.value = "";
      fTime.value = "";
      fTag.value = "todo";
      fSource.value = "Calendar";
      fDate.value = state.editingDate;
      fNote.value = "";

      openModal();
    }

    function findItemById(id){
      for(const [dayIso, items] of Object.entries(store.items)){
        const idx = items.findIndex(x => x.id === id);
        if(idx >= 0) return { dayIso, idx, item: items[idx] };
      }
      return null;
    }

    function openEdit(id, dayIso){
      const hit = findItemById(id);
      if(!hit) return;

      state.editingId = id;
      state.editingDate = hit.dayIso;

      modalTitle.textContent = "일정 편집";
      deleteBtn.style.visibility = "visible";

      fTitle.value = hit.item.title || "";
      fTime.value = hit.item.time || "";
      fTag.value = hit.item.tag || "todo";
      fSource.value = hit.item.source || "Calendar";
      fDate.value = hit.dayIso;
      fNote.value = hit.item.note || "";

      openModal();
    }

    function upsertFromForm(){
      const title = (fTitle.value || "").trim();
      const time  = (fTime.value || "").trim();
      const tag   = fTag.value;
      const source= (fSource.value || "").trim();
      const dateIso = fDate.value || isoDate(state.selected);
      const note  = (fNote.value || "").trim();

      if(!title){
        fTitle.focus();
        return;
      }

      const now = Date.now();

      if(state.editingId){
        const hit = findItemById(state.editingId);
        if(!hit) return;

        const item = hit.item;
        item.title = title;
        item.time = time || "";
        item.tag = tag;
        item.source = source || "Calendar";
        item.note = note;
        item.updatedAt = now;

        if(hit.dayIso !== dateIso){
          // 날짜 이동
          store.items[hit.dayIso].splice(hit.idx,1);
          ensureDayBucket(dateIso).push(item);
          if(store.items[hit.dayIso].length === 0) delete store.items[hit.dayIso];
        }

        saveStore();
        return;
      }

      const item = {
        id: uuid(),
        title,
        time: time || "",
        tag,
        source: source || "Calendar",
        note,
        createdAt: now,
        updatedAt: now
      };

      ensureDayBucket(dateIso).push(item);
      saveStore();
    }

    function removeItem(dayIso, id){
      const bucket = store.items[dayIso];
      if(!bucket) return;
      const idx = bucket.findIndex(x => x.id === id);
      if(idx >= 0){
        bucket.splice(idx,1);
        if(bucket.length === 0) delete store.items[dayIso];
        saveStore();
      }
    }

    function deleteCurrent(){
      if(!state.editingId) return;
      const hit = findItemById(state.editingId);
      if(!hit) return;
      removeItem(hit.dayIso, state.editingId);
    }

    // Controls
    $("#addBtn").addEventListener("click", openNew);
    $("#todayBtn").addEventListener("click", () => {
      const t = new Date(); t.setHours(0,0,0,0);
      // 레일 앵커가 너무 멀면 재설정
      const deltaDays = Math.round((t - state.railAnchor) / (24*3600*1000));
      if(deltaDays < 0 || deltaDays > state.railDays-1){
        state.railAnchor = startOfWeek(t);
        renderRail();
      }
      setSelected(t);
    });

    $("#monthBtn").addEventListener("click", () => {
      const d = state.selected;
      monthPicker.value = `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
      monthPicker.showPicker?.();
      monthPicker.click();
    });

    monthPicker.addEventListener("change", () => {
      if(!monthPicker.value) return;
      const [y,m] = monthPicker.value.split("-").map(Number);
      const d = new Date(y, m-1, 1);
      d.setHours(0,0,0,0);
      state.railAnchor = startOfWeek(d);
      renderRail();
      setSelected(d);
    });

    $("#closeModalBtn").addEventListener("click", closeModal);
    $("#cancelBtn").addEventListener("click", closeModal);

    modalOverlay.addEventListener("click", (e) => {
      if(e.target === modalOverlay) closeModal();
    });

    $("#saveBtn").addEventListener("click", () => {
      upsertFromForm();
      closeModal();

      // 편집 날짜가 현재 선택 날짜와 다를 수 있으니, 폼 날짜로 이동
      const target = parseIsoDate(fDate.value || isoDate(state.selected));
      // 레일 범위 밖이면 앵커 갱신
      const deltaDays = Math.round((target - state.railAnchor) / (24*3600*1000));
      if(deltaDays < 0 || deltaDays > state.railDays-1){
        state.railAnchor = startOfWeek(target);
        renderRail();
      }
      setSelected(target);
    });

    $("#deleteBtn").addEventListener("click", () => {
      deleteCurrent();
      closeModal();
      renderList();
    });

    // Keyboard
    window.addEventListener("keydown", (e) => {
      if(modalOverlay.getAttribute("aria-hidden")==="false"){
        if(e.key === "Escape") closeModal();
        if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "enter"){
          upsertFromForm();
          closeModal();
          renderList();
        }
        return;
      }

      if(e.key === "ArrowLeft"){
        setSelected(addDays(state.selected, -1), {scrollIntoView:true});
      }else if(e.key === "ArrowRight"){
        setSelected(addDays(state.selected, 1), {scrollIntoView:true});
      }else if(e.key.toLowerCase() === "n"){
        openNew();
      }
    });

    // Seed example items only on first run
    function seedIfEmpty(){
      const hasAny = Object.keys(store.items).length > 0;
      if(hasAny) return;

      const today = new Date(); today.setHours(0,0,0,0);
      const iso = isoDate(today);

      store.items[iso] = [
        { id: uuid(), title: "Title", time:"09:40", tag:"todo", source:"Calendar", note:"", createdAt: Date.now(), updatedAt: Date.now() },
        { id: uuid(), title: "Title", time:"00:30", tag:"workshop", source:"Calendar", note:"", createdAt: Date.now(), updatedAt: Date.now() }
      ];
      saveStore();
    }

    // PWA SW
    async function registerSW(){
      if(!("serviceWorker" in navigator)) return;
      try{
        await navigator.serviceWorker.register("./sw.js");
      }catch(e){}
    }

    seedIfEmpty();
    renderRail();
    setSelected(new Date(), {scrollIntoView:true});
    registerSW();
  </script>
</body>
</html>
