<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#f2f2f7" />
  <meta name="color-scheme" content="light" />
  <title>DayRail</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./icons/icon-192.png" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />

  <style>
    :root{
      --bg: #f2f2f7;
      --surface: #ffffff;
      --ink: #111115;
      --muted: #6b6b74;
      --hair: rgba(20,20,26,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius-lg: 22px;
      --radius-md: 16px;
      --radius-sm: 12px;

      --blue: #007aff;
      --blue-weak: rgba(0,122,255,.12);

      --chip-gray: #e9e9ee;
      --chip-gray-ink: #26262c;

      --chip-yellow: #ffe39b;
      --chip-yellow-ink: #7a5a00;

      --chip-green: #b9f7b4;
      --chip-green-ink: #155d1c;

      --chip-purple: #e2d3ff;
      --chip-purple-ink: #4a2a8a;

      --chip-red: #ffd1d1;
      --chip-red-ink: #7a1d1d;

      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
    }

    *{ box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", Segoe UI, Roboto, Helvetica, Arial, "Segoe UI Emoji";
      background: var(--bg);
      color: var(--ink);
    }

    button, input, select, textarea{
      font: inherit;
      color: inherit;
    }

    .app{
      min-height: 100%;
      padding: calc(10px + var(--safe-top)) calc(14px + var(--safe-right)) calc(96px + var(--safe-bottom)) calc(14px + var(--safe-left));
      display: flex;
      justify-content: center;
    }

    .shell{
      width: min(960px, 100%);
    }

    .topHint{
      font-size: 12px;
      color: rgba(20,20,26,.28);
      margin: 0 0 8px 10px;
      user-select: none;
    }

    .topBar{
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 10px;
      padding: 6px 6px 10px;
    }

    .monthBtn{
      justify-self: start;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: rgba(255,255,255,.65);
      border: 1px solid var(--hair);
      border-radius: 999px;
      box-shadow: 0 1px 0 rgba(0,0,0,.04);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      cursor: pointer;
      user-select: none;
    }
    .monthBtn:active{ transform: translateY(1px); }
    .chev{
      width: 10px; height: 10px;
      border-left: 2px solid rgba(20,20,26,.55);
      border-bottom: 2px solid rgba(20,20,26,.55);
      transform: rotate(45deg);
      margin-left: 2px;
    }

    .title{
      justify-self: center;
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -.2px;
      user-select: none;
    }

    .ghostRight{
      justify-self: end;
      display: flex;
      gap: 8px;
      align-items: center;
      user-select: none;
    }

    .miniBtn{
      height: 36px;
      padding: 0 12px;
      border: 1px solid var(--hair);
      background: rgba(255,255,255,.65);
      border-radius: 999px;
      cursor: pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,.04);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .miniBtn:active{ transform: translateY(1px); }

    .monthGridWrap{
      background: rgba(255,255,255,.55);
      border: 1px solid var(--hair);
      border-radius: var(--radius-lg);
      box-shadow: 0 1px 0 rgba(0,0,0,.04);
      padding: 14px 14px 12px;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    .monthHeader{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 2px 2px 10px;
    }

    .monthTitle{
      font-size: 18px;
      font-weight: 800;
      letter-spacing: -.2px;
    }

    .monthSub{
      margin-top: 4px;
      font-size: 12px;
      color: rgba(20,20,26,.45);
      font-weight: 700;
    }

    .monthNav{
      display: flex;
      gap: 6px;
    }

    .navBtn{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid var(--hair);
      background: rgba(255,255,255,.8);
      cursor: pointer;
      display: grid;
      place-items: center;
    }
    .navBtn:active{ transform: translateY(1px); }
    .navBtn span{
      display: block;
      width: 8px; height: 8px;
      border-left: 2px solid rgba(20,20,26,.6);
      border-bottom: 2px solid rgba(20,20,26,.6);
      transform: rotate(45deg);
    }
    .navBtn.next span{ transform: rotate(-135deg); }

    .dowRow{
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      padding: 0 2px 8px;
      color: rgba(20,20,26,.30);
      font-weight: 700;
      font-size: 12px;
      letter-spacing: .2px;
      user-select: none;
    }
    .dowRow span{ text-align: center; }

    .monthGrid{
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }

    .monthCell{
      min-height: 74px;
      border-radius: 16px;
      border: 1px solid transparent;
      background: rgba(255,255,255,.5);
      padding: 8px 8px 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      cursor: pointer;
      position: relative;
    }
    .monthCell:hover{ border-color: rgba(0,122,255,.25); }
    .monthCell.is-muted{
      color: rgba(20,20,26,.28);
      background: rgba(255,255,255,.35);
    }
    .monthCell.is-selected{
      border-color: rgba(0,122,255,.45);
      background: rgba(0,122,255,.08);
    }
    .monthCell.is-today::after{
      content: "";
      position: absolute;
      right: 8px;
      top: 8px;
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--blue);
    }

    .monthDay{
      font-size: 14px;
      font-weight: 800;
      letter-spacing: -.2px;
    }

    .countPill{
      align-self: flex-start;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 800;
      color: rgba(0,122,255,.9);
      background: rgba(0,122,255,.12);
    }

    .dots{
      display: flex;
      gap: 4px;
      margin-top: auto;
    }
    .dot{
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(0,122,255,.4);
    }

    .content{
      margin-top: 14px;
      display: grid;
      gap: 14px;
    }

    .sectionHeader{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 2px 6px;
    }

    .sectionTitle{
      margin: 0;
      font-size: 18px;
      font-weight: 800;
    }

    .emptyState{
      padding: 22px 20px;
      border-radius: var(--radius-lg);
      border: 1px dashed rgba(20,20,26,.18);
      color: rgba(20,20,26,.55);
      background: rgba(255,255,255,.40);
    }

    .card{
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      padding: 18px 18px 16px;
      border: 1px solid rgba(20,20,26,.06);
    }

    .rowTop{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .cardTitle{
      font-size: 24px;
      font-weight: 800;
      letter-spacing: -.4px;
      line-height: 1.1;
      margin: 0;
      flex: 1;
      min-width: 0;
    }

    .timePill{
      flex: 0 0 auto;
      padding: 8px 12px;
      background: var(--chip-gray);
      color: rgba(20,20,26,.85);
      border-radius: 999px;
      font-weight: 800;
      letter-spacing: .2px;
      font-variant-numeric: tabular-nums;
      user-select: none;
      text-align: right;
      max-width: 220px;
    }

    .divider{
      height: 1px;
      background: rgba(20,20,26,.08);
      margin: 12px 0 12px;
    }

    .rowMeta{
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .metaLeft{
      display: grid;
      gap: 6px;
    }

    .source{
      color: rgba(20,20,26,.60);
      font-weight: 700;
      letter-spacing: -.1px;
      user-select: none;
    }

    .rangeText{
      font-size: 12px;
      color: rgba(20,20,26,.45);
      font-weight: 700;
    }

    .tagPill{
      padding: 8px 14px;
      border-radius: 999px;
      font-weight: 900;
      letter-spacing: -.1px;
      user-select: none;
      white-space: nowrap;
    }

    .tag-yellow{ background: var(--chip-yellow); color: var(--chip-yellow-ink); }
    .tag-green{ background: var(--chip-green); color: var(--chip-green-ink); }
    .tag-blue{ background: rgba(0,122,255,.16); color: #0059bf; }
    .tag-purple{ background: var(--chip-purple); color: var(--chip-purple-ink); }
    .tag-red{ background: var(--chip-red); color: var(--chip-red-ink); }
    .tag-gray{ background: var(--chip-gray); color: var(--chip-gray-ink); }

    .note{
      margin-top: 10px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(20,20,26,.08);
      padding: 12px 12px;
      background: rgba(242,242,247,.55);
    }

    .note textarea{
      width: 100%;
      min-height: 44px;
      resize: vertical;
      border: 0;
      outline: 0;
      background: transparent;
      color: rgba(20,20,26,.85);
      font-weight: 650;
      letter-spacing: -.1px;
      line-height: 1.35;
    }
    .note textarea::placeholder{ color: rgba(20,20,26,.25); }

    .cardActions{
      margin-top: 12px;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .linkBtn{
      border: 1px solid rgba(20,20,26,.10);
      background: rgba(255,255,255,.55);
      padding: 8px 12px;
      border-radius: 999px;
      cursor: pointer;
      color: rgba(20,20,26,.75);
      font-weight: 750;
    }
    .linkBtn:active{ transform: translateY(1px); }
    .danger{ color: #7a1d1d; border-color: rgba(122,29,29,.18); background: rgba(255,209,209,.45); }

    .fab{
      position: fixed;
      left: 50%;
      bottom: calc(18px + var(--safe-bottom));
      transform: translateX(-50%);
      width: 64px;
      height: 64px;
      border-radius: 999px;
      border: 1px solid rgba(20,20,26,.10);
      background: rgba(255,255,255,.85);
      box-shadow: 0 18px 40px rgba(0,0,0,.16);
      display: grid;
      place-items: center;
      cursor: pointer;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
    .fab:active{ transform: translateX(-50%) translateY(1px); }
    .plus{
      width: 22px; height: 22px;
      position: relative;
    }
    .plus::before,.plus::after{
      content: "";
      position: absolute;
      left: 50%; top: 50%;
      transform: translate(-50%,-50%);
      background: var(--blue);
      border-radius: 3px;
    }
    .plus::before{ width: 22px; height: 4px; }
    .plus::after{ width: 4px; height: 22px; }

    .modalOverlay{
      position: fixed;
      inset: 0;
      background: rgba(10,10,14,.42);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }
    .modalOverlay[aria-hidden="false"]{ display: flex; }

    .modal{
      width: min(600px, 100%);
      background: rgba(255,255,255,.92);
      border-radius: 26px;
      border: 1px solid rgba(20,20,26,.10);
      box-shadow: 0 30px 90px rgba(0,0,0,.25);
      padding: 16px 16px 14px;
    }

    .modalHeader{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 6px 6px 10px;
    }
    .modalHeader h2{
      margin: 0;
      font-size: 18px;
      font-weight: 900;
      letter-spacing: -.2px;
    }

    .modalBody{
      padding: 6px 6px 2px;
      display: grid;
      gap: 12px;
    }

    .field{
      display: grid;
      gap: 6px;
    }
    .label{
      font-size: 12px;
      color: rgba(20,20,26,.52);
      font-weight: 800;
      letter-spacing: .2px;
      user-select: none;
    }
    .input, .select, .textarea{
      width: 100%;
      border: 1px solid rgba(20,20,26,.10);
      background: rgba(242,242,247,.70);
      border-radius: 14px;
      padding: 12px 12px;
      outline: none;
      font-weight: 750;
      letter-spacing: -.1px;
    }
    .textarea{
      min-height: 82px;
      resize: vertical;
      font-weight: 650;
      line-height: 1.35;
    }

    .toggleRow{
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 2px 0;
      font-weight: 800;
      color: rgba(20,20,26,.7);
    }

    .modalFooter{
      display: flex;
      gap: 10px;
      justify-content: space-between;
      padding: 12px 6px 6px;
      align-items: center;
    }

    .primary{
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(0,122,255,.20);
      background: rgba(0,122,255,.12);
      color: #0059bf;
      font-weight: 900;
      cursor: pointer;
    }
    .secondary{
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(20,20,26,.12);
      background: rgba(255,255,255,.65);
      color: rgba(20,20,26,.80);
      font-weight: 900;
      cursor: pointer;
    }
    .primary:active, .secondary:active{ transform: translateY(1px); }

    .split{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    @media (min-width: 900px){
      .app{ padding-bottom: calc(44px + var(--safe-bottom)); }
      .fab{ left: calc(50% + 400px); transform: translateX(-50%); }
      .fab:active{ transform: translateX(-50%) translateY(1px); }
    }

    @media (prefers-reduced-motion: reduce){
      *{ transition: none !important; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="shell" role="application" aria-label="DayRail">
      <div class="topHint">Calendar</div>

      <div class="topBar">
        <button class="monthBtn" id="monthBtn" type="button" aria-label="월 선택">
          <span class="chev" aria-hidden="true"></span>
          <span id="monthBtnLabel">12월</span>
        </button>

        <div class="title" id="titleLabel">12월 25일, 오늘</div>

        <div class="ghostRight">
          <button class="miniBtn" id="prevMonthBtn" type="button" aria-label="이전 달">◀︎</button>
          <button class="miniBtn" id="nextMonthBtn" type="button" aria-label="다음 달">▶︎</button>
          <button class="miniBtn" id="todayBtn" type="button">오늘</button>
        </div>
      </div>

      <section class="monthGridWrap" aria-label="월 달력">
        <div class="monthHeader">
          <div>
            <div class="monthTitle" id="monthTitle">2024년 12월</div>
            <div class="monthSub" id="monthSub">이 달 일정 0개</div>
          </div>
          <div class="monthNav">
            <button class="navBtn prev" id="prevMonthMini" type="button" aria-label="이전 달"><span aria-hidden="true"></span></button>
            <button class="navBtn next" id="nextMonthMini" type="button" aria-label="다음 달"><span aria-hidden="true"></span></button>
          </div>
        </div>
        <div class="dowRow" aria-hidden="true">
          <span>SUN</span><span>MON</span><span>TUE</span><span>WED</span><span>THU</span><span>FRI</span><span>SAT</span>
        </div>
        <div class="monthGrid" id="monthGrid"></div>
      </section>

      <main class="content" id="content">
        <div class="sectionHeader">
          <h2 class="sectionTitle">일정</h2>
          <div class="monthSub" id="daySummary">오늘 일정 0개</div>
        </div>
      </main>
    </div>
  </div>

  <button class="fab" id="addBtn" type="button" aria-label="일정 추가">
    <div class="plus" aria-hidden="true"></div>
  </button>

  <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="일정 편집">
      <div class="modalHeader">
        <h2 id="modalTitle">새 일정</h2>
        <button class="secondary" id="closeModalBtn" type="button">닫기</button>
      </div>

      <div class="modalBody">
        <div class="field">
          <div class="label">제목</div>
          <input class="input" id="fTitle" type="text" placeholder="Title" autocomplete="off" />
        </div>

        <div class="split">
          <div class="field">
            <div class="label">시작 날짜</div>
            <input class="input" id="fStartDate" type="date" />
          </div>

          <div class="field">
            <div class="label">시작 시간</div>
            <input class="input" id="fStartTime" type="time" />
          </div>
        </div>

        <div class="split">
          <div class="field">
            <div class="label">종료 날짜</div>
            <input class="input" id="fEndDate" type="date" />
          </div>

          <div class="field">
            <div class="label">종료 시간</div>
            <input class="input" id="fEndTime" type="time" />
          </div>
        </div>

        <label class="toggleRow">
          <input id="fAllDay" type="checkbox" />
          하루 종일
        </label>

        <div class="split">
          <div class="field">
            <div class="label">태그</div>
            <select class="select" id="fTag">
              <option value="todo">To-Do</option>
              <option value="workshop">Workshop</option>
              <option value="meeting">Meeting</option>
              <option value="personal">Personal</option>
              <option value="idea">Idea</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>

          <div class="field">
            <div class="label">소스</div>
            <input class="input" id="fSource" type="text" placeholder="Calendar" autocomplete="off" />
          </div>
        </div>

        <div class="field">
          <div class="label">메모</div>
          <textarea class="textarea" id="fNote" placeholder="Write Something..."></textarea>
        </div>
      </div>

      <div class="modalFooter">
        <button class="secondary danger" id="deleteBtn" type="button" style="visibility:hidden;">삭제</button>
        <div style="display:flex; gap:10px;">
          <button class="secondary" id="cancelBtn" type="button">취소</button>
          <button class="primary" id="saveBtn" type="button">저장</button>
        </div>
      </div>
    </div>
  </div>

  <input id="monthPicker" type="month" style="position:fixed; left:-9999px; top:-9999px;" />

  <script>
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    const STORAGE_KEY = "dayrail.v1";

    const TAGS = {
      todo:   { label: "To-Do",    className: "tag-yellow" },
      workshop:{ label:"Workshop", className: "tag-green" },
      meeting:{ label:"Meeting",   className: "tag-blue" },
      personal:{label:"Personal",  className: "tag-purple" },
      idea:   { label: "Idea",     className: "tag-gray" },
      urgent: { label: "Urgent",   className: "tag-red" }
    };

    function pad2(n){ return String(n).padStart(2,"0"); }
    function isoDate(d){
      const x = new Date(d);
      x.setHours(0,0,0,0);
      return `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`;
    }
    function parseIsoDate(s){
      const [y,m,d] = s.split("-").map(Number);
      const dt = new Date(y, m-1, d);
      dt.setHours(0,0,0,0);
      return dt;
    }
    function startOfWeek(d){
      const x = new Date(d);
      const day = x.getDay(); // 0 Sun
      x.setDate(x.getDate() - day);
      x.setHours(0,0,0,0);
      return x;
    }
    function startOfMonth(d){
      return new Date(d.getFullYear(), d.getMonth(), 1);
    }
    function addDays(d, n){
      const x = new Date(d);
      x.setDate(x.getDate()+n);
      return x;
    }
    function addMonths(d, n){
      return new Date(d.getFullYear(), d.getMonth()+n, 1);
    }
    function isSameDay(a,b){
      return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
    }
    function isSameMonth(a,b){
      return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth();
    }
    function formatTitle(d){
      const today = new Date(); today.setHours(0,0,0,0);
      const isToday = isSameDay(d, today);
      const fmt = new Intl.DateTimeFormat("ko-KR", { month:"long", day:"numeric" });
      return isToday ? `${fmt.format(d)}, 오늘` : fmt.format(d);
    }
    function formatMonth(d){
      return new Intl.DateTimeFormat("ko-KR", { month:"long" }).format(d);
    }
    function formatMonthTitle(d){
      return new Intl.DateTimeFormat("ko-KR", { year:"numeric", month:"long" }).format(d);
    }
    function timeLabel(t){
      if(!t) return "All-day";
      const [hh, mm] = t.split(":").map(Number);
      const isAM = hh < 12;
      let h12 = hh % 12; if(h12===0) h12 = 12;
      const ap = isAM ? "AM" : "PM";
      return `${h12}:${pad2(mm)} ${ap}`;
    }
    function uuid(){
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function normalizeEvent(event){
      const startDate = event.startDate || event.date || isoDate(new Date());
      const endDate = event.endDate || startDate;
      return {
        id: event.id || uuid(),
        title: event.title || "",
        startDate,
        endDate,
        startTime: event.startTime || event.time || "",
        endTime: event.endTime || "",
        tag: event.tag || "todo",
        source: event.source || "Calendar",
        note: event.note || "",
        createdAt: event.createdAt || Date.now(),
        updatedAt: event.updatedAt || Date.now()
      };
    }

    function migrateStore(data){
      if(data && Array.isArray(data.events)){
        return { version: 2, events: data.events.map(normalizeEvent) };
      }

      if(data && data.items){
        const events = [];
        for(const [dayIso, items] of Object.entries(data.items)){
          for(const item of items){
            events.push(normalizeEvent({
              ...item,
              startDate: dayIso,
              endDate: dayIso,
              startTime: item.time || "",
              endTime: ""
            }));
          }
        }
        return { version: 2, events };
      }

      return { version: 2, events: [] };
    }

    function loadStore(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return { version: 2, events: [] };
        const data = JSON.parse(raw);
        if(!data || typeof data !== "object") throw new Error("bad");
        return migrateStore(data);
      }catch(e){
        return { version: 2, events: [] };
      }
    }
    function saveStore(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
    }

    let store = loadStore();

    const state = {
      selected: new Date(),
      viewMonth: startOfMonth(new Date()),
      editingId: null
    };

    const content = $("#content");
    const titleLabel = $("#titleLabel");
    const monthBtnLabel = $("#monthBtnLabel");
    const monthTitle = $("#monthTitle");
    const monthSub = $("#monthSub");
    const monthGrid = $("#monthGrid");
    const daySummary = $("#daySummary");

    const modalOverlay = $("#modalOverlay");
    const monthPicker = $("#monthPicker");

    const fTitle = $("#fTitle");
    const fStartDate = $("#fStartDate");
    const fStartTime  = $("#fStartTime");
    const fEndDate  = $("#fEndDate");
    const fEndTime  = $("#fEndTime");
    const fAllDay = $("#fAllDay");
    const fTag   = $("#fTag");
    const fSource= $("#fSource");
    const fNote  = $("#fNote");

    const modalTitle = $("#modalTitle");
    const deleteBtn  = $("#deleteBtn");

    function eventsForDay(iso){
      return store.events.filter(event => event.startDate <= iso && event.endDate >= iso);
    }

    function eventsInMonth(viewDate){
      const monthStart = isoDate(startOfMonth(viewDate));
      const monthEnd = isoDate(addDays(addMonths(startOfMonth(viewDate), 1), -1));
      return store.events.filter(event => event.startDate <= monthEnd && event.endDate >= monthStart);
    }

    function eventSort(a,b){
      const aKey = a.startTime || "99:99";
      const bKey = b.startTime || "99:99";
      if(aKey < bKey) return -1;
      if(aKey > bKey) return 1;
      return (a.updatedAt||0) - (b.updatedAt||0);
    }

    function setSelected(d){
      const x = new Date(d); x.setHours(0,0,0,0);
      state.selected = x;

      titleLabel.textContent = formatTitle(x);
      monthBtnLabel.textContent = formatMonth(x).replace("월","월");

      if(!isSameMonth(x, state.viewMonth)){
        state.viewMonth = startOfMonth(x);
      }

      renderMonthGrid();
      renderList();
    }

    function setViewMonth(d){
      state.viewMonth = startOfMonth(d);
      monthBtnLabel.textContent = formatMonth(state.viewMonth).replace("월","월");
      renderMonthGrid();
    }

    function renderMonthGrid(){
      monthGrid.innerHTML = "";
      const today = new Date(); today.setHours(0,0,0,0);

      monthTitle.textContent = formatMonthTitle(state.viewMonth);

      const monthEvents = eventsInMonth(state.viewMonth);
      monthSub.textContent = `이 달 일정 ${monthEvents.length}개`;

      const firstDay = startOfMonth(state.viewMonth);
      const gridStart = startOfWeek(firstDay);

      for(let i=0;i<42;i++){
        const day = addDays(gridStart, i);
        const iso = isoDate(day);
        const inMonth = day.getMonth() === state.viewMonth.getMonth();
        const cell = document.createElement("button");
        cell.type = "button";
        cell.className = "monthCell" + (inMonth ? "" : " is-muted");
        if(isSameDay(day, today)) cell.className += " is-today";
        if(isSameDay(day, state.selected)) cell.className += " is-selected";
        cell.setAttribute("aria-label", new Intl.DateTimeFormat("ko-KR", { month:"long", day:"numeric", weekday:"short" }).format(day));

        const dayNum = document.createElement("div");
        dayNum.className = "monthDay";
        dayNum.textContent = day.getDate();

        const dayEvents = eventsForDay(iso);

        cell.appendChild(dayNum);

        if(dayEvents.length){
          const count = document.createElement("div");
          count.className = "countPill";
          count.textContent = `${dayEvents.length}개`;
          cell.appendChild(count);
        }

        const dots = document.createElement("div");
        dots.className = "dots";
        dayEvents.slice(0,3).forEach(() => {
          const dot = document.createElement("span");
          dot.className = "dot";
          dots.appendChild(dot);
        });

        cell.appendChild(dots);
        cell.addEventListener("click", () => setSelected(day));
        monthGrid.appendChild(cell);
      }
    }

    function timeRangeLabel(event){
      const sameDay = event.startDate === event.endDate;
      if(!event.startTime && !event.endTime){
        return sameDay ? "All-day" : "All-day · Multi-day";
      }
      if(sameDay){
        if(event.startTime && event.endTime){
          return `${timeLabel(event.startTime)} – ${timeLabel(event.endTime)}`;
        }
        return timeLabel(event.startTime || event.endTime);
      }
      const startLabel = `${event.startDate}${event.startTime ? ` ${timeLabel(event.startTime)}` : ""}`;
      const endLabel = `${event.endDate}${event.endTime ? ` ${timeLabel(event.endTime)}` : ""}`;
      return `${startLabel} → ${endLabel}`;
    }

    function rangeMetaLabel(event){
      if(event.startDate === event.endDate) return "";
      return `${event.startDate} → ${event.endDate}`;
    }

    function renderList(){
      const iso = isoDate(state.selected);
      const items = eventsForDay(iso).slice().sort(eventSort);

      $$(`.card, .emptyState`, content).forEach(node => node.remove());

      daySummary.textContent = `${iso} 일정 ${items.length}개`;

      if(items.length === 0){
        const empty = document.createElement("div");
        empty.className = "emptyState";
        empty.textContent = "이 날짜에는 등록된 일정이 없음";
        content.appendChild(empty);
        return;
      }

      for(const item of items){
        const card = document.createElement("section");
        card.className = "card";
        card.dataset.id = item.id;

        const rowTop = document.createElement("div");
        rowTop.className = "rowTop";

        const h = document.createElement("h3");
        h.className = "cardTitle";
        h.textContent = item.title || "Untitled";

        const time = document.createElement("div");
        time.className = "timePill";
        time.textContent = timeRangeLabel(item);

        rowTop.appendChild(h);
        rowTop.appendChild(time);

        const div = document.createElement("div");
        div.className = "divider";

        const rowMeta = document.createElement("div");
        rowMeta.className = "rowMeta";

        const metaLeft = document.createElement("div");
        metaLeft.className = "metaLeft";

        const src = document.createElement("div");
        src.className = "source";
        src.textContent = item.source || "Calendar";

        metaLeft.appendChild(src);

        const rangeLabel = rangeMetaLabel(item);
        if(rangeLabel){
          const range = document.createElement("div");
          range.className = "rangeText";
          range.textContent = rangeLabel;
          metaLeft.appendChild(range);
        }

        const tag = document.createElement("div");
        const tagInfo = TAGS[item.tag] || TAGS.todo;
        tag.className = `tagPill ${tagInfo.className}`;
        tag.textContent = tagInfo.label;

        rowMeta.appendChild(metaLeft);
        rowMeta.appendChild(tag);

        const noteWrap = document.createElement("div");
        noteWrap.className = "note";

        const ta = document.createElement("textarea");
        ta.placeholder = "Write Something...";
        ta.value = item.note || "";
        ta.addEventListener("input", () => {
          const hit = findEventById(item.id);
          if(hit){
            hit.note = ta.value;
            hit.updatedAt = Date.now();
            saveStore();
          }
        });

        noteWrap.appendChild(ta);

        const actions = document.createElement("div");
        actions.className = "cardActions";

        const editBtn = document.createElement("button");
        editBtn.className = "linkBtn";
        editBtn.type = "button";
        editBtn.textContent = "편집";
        editBtn.addEventListener("click", () => openEdit(item.id));

        const delBtn = document.createElement("button");
        delBtn.className = "linkBtn danger";
        delBtn.type = "button";
        delBtn.textContent = "삭제";
        delBtn.addEventListener("click", () => {
          removeEvent(item.id);
          renderMonthGrid();
          renderList();
        });

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        card.appendChild(rowTop);
        card.appendChild(div);
        card.appendChild(rowMeta);
        card.appendChild(noteWrap);
        card.appendChild(actions);

        content.appendChild(card);
      }
    }

    function openModal(){
      modalOverlay.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
      setTimeout(() => fTitle.focus(), 0);
    }
    function closeModal(){
      modalOverlay.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
      state.editingId = null;
    }

    function setAllDay(isAllDay){
      fAllDay.checked = isAllDay;
      fStartTime.disabled = isAllDay;
      fEndTime.disabled = isAllDay;
      if(isAllDay){
        fStartTime.value = "";
        fEndTime.value = "";
      }
    }

    function openNew(){
      state.editingId = null;

      modalTitle.textContent = "새 일정";
      deleteBtn.style.visibility = "hidden";

      const iso = isoDate(state.selected);
      fTitle.value = "";
      fStartDate.value = iso;
      fStartTime.value = "";
      fEndDate.value = iso;
      fEndTime.value = "";
      setAllDay(true);
      fTag.value = "todo";
      fSource.value = "Calendar";
      fNote.value = "";

      openModal();
    }

    function findEventById(id){
      return store.events.find(event => event.id === id) || null;
    }

    function openEdit(id){
      const hit = findEventById(id);
      if(!hit) return;

      state.editingId = id;

      modalTitle.textContent = "일정 편집";
      deleteBtn.style.visibility = "visible";

      fTitle.value = hit.title || "";
      fStartDate.value = hit.startDate;
      fStartTime.value = hit.startTime || "";
      fEndDate.value = hit.endDate || hit.startDate;
      fEndTime.value = hit.endTime || "";
      setAllDay(!hit.startTime && !hit.endTime);
      fTag.value = hit.tag || "todo";
      fSource.value = hit.source || "Calendar";
      fNote.value = hit.note || "";

      openModal();
    }

    function upsertFromForm(){
      const title = (fTitle.value || "").trim();
      const startDate = fStartDate.value || isoDate(state.selected);
      const endDate = fEndDate.value || startDate;
      const startTime = fAllDay.checked ? "" : (fStartTime.value || "").trim();
      const endTime = fAllDay.checked ? "" : (fEndTime.value || "").trim();
      const tag   = fTag.value;
      const source= (fSource.value || "").trim();
      const note  = (fNote.value || "").trim();

      if(!title){
        fTitle.focus();
        return false;
      }

      const now = Date.now();

      if(state.editingId){
        const hit = findEventById(state.editingId);
        if(!hit) return false;

        Object.assign(hit, {
          title,
          startDate,
          endDate,
          startTime,
          endTime,
          tag,
          source: source || "Calendar",
          note,
          updatedAt: now
        });

        saveStore();
        return true;
      }

      const event = normalizeEvent({
        id: uuid(),
        title,
        startDate,
        endDate,
        startTime,
        endTime,
        tag,
        source: source || "Calendar",
        note,
        createdAt: now,
        updatedAt: now
      });

      store.events.push(event);
      saveStore();
      return true;
    }

    function removeEvent(id){
      const idx = store.events.findIndex(event => event.id === id);
      if(idx >= 0){
        store.events.splice(idx,1);
        saveStore();
      }
    }

    function deleteCurrent(){
      if(!state.editingId) return;
      removeEvent(state.editingId);
    }

    // Controls
    $("#addBtn").addEventListener("click", openNew);
    $("#todayBtn").addEventListener("click", () => {
      const t = new Date(); t.setHours(0,0,0,0);
      setSelected(t);
    });

    $("#prevMonthBtn").addEventListener("click", () => {
      setViewMonth(addMonths(state.viewMonth, -1));
    });
    $("#nextMonthBtn").addEventListener("click", () => {
      setViewMonth(addMonths(state.viewMonth, 1));
    });
    $("#prevMonthMini").addEventListener("click", () => {
      setViewMonth(addMonths(state.viewMonth, -1));
    });
    $("#nextMonthMini").addEventListener("click", () => {
      setViewMonth(addMonths(state.viewMonth, 1));
    });

    $("#monthBtn").addEventListener("click", () => {
      const d = state.viewMonth;
      monthPicker.value = `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
      monthPicker.showPicker?.();
      monthPicker.click();
    });

    monthPicker.addEventListener("change", () => {
      if(!monthPicker.value) return;
      const [y,m] = monthPicker.value.split("-").map(Number);
      const d = new Date(y, m-1, 1);
      d.setHours(0,0,0,0);
      setViewMonth(d);
      setSelected(d);
    });

    $("#closeModalBtn").addEventListener("click", closeModal);
    $("#cancelBtn").addEventListener("click", closeModal);

    modalOverlay.addEventListener("click", (e) => {
      if(e.target === modalOverlay) closeModal();
    });

    fAllDay.addEventListener("change", () => {
      setAllDay(fAllDay.checked);
    });

    $("#saveBtn").addEventListener("click", () => {
      if(!upsertFromForm()) return;
      closeModal();

      const target = parseIsoDate(fStartDate.value || isoDate(state.selected));
      setSelected(target);
      renderMonthGrid();
    });

    $("#deleteBtn").addEventListener("click", () => {
      deleteCurrent();
      closeModal();
      renderMonthGrid();
      renderList();
    });

    // Keyboard
    window.addEventListener("keydown", (e) => {
      if(modalOverlay.getAttribute("aria-hidden")==="false"){
        if(e.key === "Escape") closeModal();
        if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "enter"){
          if(!upsertFromForm()) return;
          closeModal();
          renderMonthGrid();
          renderList();
        }
        return;
      }

      if(e.key === "ArrowLeft"){
        setSelected(addDays(state.selected, -1));
      }else if(e.key === "ArrowRight"){
        setSelected(addDays(state.selected, 1));
      }else if(e.key.toLowerCase() === "n"){
        openNew();
      }
    });

    // Seed example items only on first run
    function seedIfEmpty(){
      if(store.events.length > 0) return;

      const today = new Date(); today.setHours(0,0,0,0);
      const tomorrow = addDays(today, 1);

      store.events = [
        normalizeEvent({ id: uuid(), title: "기획 싱크", startDate: isoDate(today), endDate: isoDate(today), startTime:"09:40", endTime:"10:20", tag:"todo", source:"Calendar", note:"프로젝트 목표 정리", createdAt: Date.now(), updatedAt: Date.now() }),
        normalizeEvent({ id: uuid(), title: "워크숍", startDate: isoDate(tomorrow), endDate: isoDate(tomorrow), startTime:"14:00", endTime:"16:00", tag:"workshop", source:"Calendar", note:"팀 스프린트 워크숍", createdAt: Date.now(), updatedAt: Date.now() })
      ];
      saveStore();
    }

    // PWA SW
    async function registerSW(){
      if(!("serviceWorker" in navigator)) return;
      try{
        await navigator.serviceWorker.register("./sw.js");
      }catch(e){}
    }

    seedIfEmpty();
    setSelected(new Date());
    renderMonthGrid();
    renderList();
    registerSW();
  </script>
</body>
</html>
